<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ProLogistics | Scan-to-PDF</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; }
       .qr-frame img { border: 12px solid white; border-radius: 1rem; box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1); }
        #reader { border: none!important; border-radius: 1.5rem; overflow: hidden; }
        #reader__dashboard_section_csr button { background: #4f46e5!important; color: white!important; border-radius: 0.5rem!important; padding: 0.5rem 1rem!important; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen">

    <nav class="bg-white border-b border-slate-200 sticky top-0 z-50 px-6 py-4">
        <div class="max-w-5xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-2">
                <div class="bg-indigo-600 p-1.5 rounded-lg text-white font-bold text-xl">PL</div>
                <h1 class="font-bold text-slate-800 tracking-tight text-lg">PRO-LOGISTICS</h1>
            </div>
            <div class="flex bg-slate-100 p-1 rounded-xl">
                <button onclick="tab('gen')" id="btn-gen" class="px-5 py-2 rounded-lg bg-white shadow-sm text-indigo-600 font-bold text-sm transition-all">Generator</button>
                <button onclick="tab('scan')" id="btn-scan" class="px-5 py-2 rounded-lg text-slate-500 font-bold text-sm transition-all">Scanner</button>
            </div>
        </div>
    </nav>

    <main class="max-w-5xl mx-auto p-4 md:p-8">
        
        <section id="sec-gen" class="space-y-8">
            <div class="grid lg:grid-cols-2 gap-8 items-start">
                <div class="bg-white p-8 rounded-3xl shadow-sm border border-slate-200">
                    <h2 class="text-2xl font-bold text-slate-800 mb-6">Dispatch Details</h2>
                    <form id="qrForm" class="space-y-5">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="text-[10px] font-black uppercase text-slate-400 mb-1 block">Customer</label>
                                <input type="text" id="cust" required class="w-full p-3 bg-slate-50 border rounded-xl outline-none focus:border-indigo-500 text-sm">
                            </div>
                            <div>
                                <label class="text-[10px] font-black uppercase text-slate-400 mb-1 block">Seller</label>
                                <input type="text" id="sell" required class="w-full p-3 bg-slate-50 border rounded-xl outline-none focus:border-indigo-500 text-sm">
                            </div>
                        </div>

                        <div>
                            <label class="text-[10px] font-black uppercase text-slate-400 mb-1 block">Full Delivery Address</label>
                            <textarea id="addr" required rows="2" class="w-full p-3 bg-slate-50 border rounded-xl outline-none focus:border-indigo-500 text-sm resize-none"></textarea>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="text-[10px] font-black uppercase text-slate-400 mb-1 block">Sort Zone</label>
                                <select id="zone" class="w-full p-3 bg-slate-50 border rounded-xl outline-none text-sm font-bold text-indigo-600">
                                    <option value="Zone X">Zone X</option>
                                    <option value="Zone Y">Zone Y</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-[10px] font-black uppercase text-slate-400 mb-1 block">Price (â‚¹)</label>
                                <input type="number" id="price" required class="w-full p-3 bg-slate-50 border rounded-xl outline-none focus:border-indigo-500 text-sm">
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="text-[10px] font-black uppercase text-slate-400 mb-1 block">Weight (kg)</label>
                                <input type="number" step="0.1" id="weight" required class="w-full p-3 bg-slate-50 border rounded-xl outline-none focus:border-indigo-500 text-sm">
                            </div>
                            <div>
                                <label class="text-[10px] font-black uppercase text-slate-400 mb-1 block">Product Type</label>
                                <input type="text" id="type" required class="w-full p-3 bg-slate-50 border rounded-xl outline-none focus:border-indigo-500 text-sm">
                            </div>
                        </div>

                        <div>
                            <label class="text-[10px] font-black uppercase text-slate-400 mb-1 block">Payment Method</label>
                            <select id="pay" class="w-full p-3 bg-slate-50 border rounded-xl outline-none text-sm">
                                <option value="Prepaid">Prepaid</option>
                                <option value="Cash on Delivery">Cash on Delivery</option>
                                <option value="UPI">UPI / Online</option>
                            </select>
                        </div>

                        <button type="submit" class="w-full bg-indigo-600 text-white py-4 rounded-2xl font-bold shadow-xl shadow-indigo-100 hover:bg-indigo-700 active:scale-[0.98] transition-all">
                            Generate Parcel Label
                        </button>
                    </form>
                </div>

                <div class="bg-slate-900 rounded-3xl p-12 flex flex-col items-center justify-center text-center min-h-[500px]">
                    <div id="qrcode" class="qr-frame mb-8"></div>
                    <div id="placeholder" class="text-slate-600">
                        <div class="w-16 h-16 bg-slate-800 rounded-full flex items-center justify-center mx-auto mb-4">
                            <svg class="w-8 h-8 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z" stroke-width="2"/></svg>
                        </div>
                        <p class="font-bold text-slate-400 uppercase tracking-widest text-xs">Ready for Encoding</p>
                    </div>
                    <button id="dlBtn" style="display:none;" class="bg-white/10 text-white px-6 py-2 rounded-xl text-sm font-bold hover:bg-white/20 transition-all border border-white/10">Download Label Image</button>
                </div>
            </div>
        </section>

        <section id="sec-scan" class="hidden max-w-xl mx-auto space-y-6">
            <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-200">
                <h2 class="text-xl font-bold text-center mb-4">Align QR with Scanner</h2>
                <div id="reader" class="bg-slate-50"></div>
                <p class="text-xs text-center text-slate-400 mt-4 font-bold uppercase tracking-widest">Automatic PDF Generation</p>
            </div>
            
            <div id="success" class="hidden bg-emerald-50 border border-emerald-100 p-6 rounded-3xl text-center animate-in zoom-in">
                <div class="w-12 h-12 bg-emerald-500 rounded-full flex items-center justify-center text-white mx-auto mb-3 shadow-lg shadow-emerald-200">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="3" d="M5 13l4 4L19 7"/></svg>
                </div>
                <h3 class="font-bold text-emerald-900">Scan Complete</h3>
                <p class="text-emerald-700 text-sm">Your PDF Invoice has been generated.</p>
            </div>
        </section>

    </main>

    <script>
        // TAB LOGIC
        function tab(t) {
            const isGen = t === 'gen';
            document.getElementById('sec-gen').classList.toggle('hidden', !isGen);
            document.getElementById('sec-scan').classList.toggle('hidden', isGen);
            document.getElementById('btn-gen').className = isGen ? 'px-5 py-2 rounded-lg bg-white shadow-sm text-indigo-600 font-bold text-sm' : 'px-5 py-2 rounded-lg text-slate-500 font-bold text-sm';
            document.getElementById('btn-scan').className = !isGen ? 'px-5 py-2 rounded-lg bg-white shadow-sm text-indigo-600 font-bold text-sm' : 'px-5 py-2 rounded-lg text-slate-500 font-bold text-sm';
            
            if (!isGen) startScanner(); else stopScanner();
        }

        // GENERATOR LOGIC
        const qrForm = document.getElementById('qrForm');
        const qrcodeDiv = document.getElementById('qrcode');
        const placeholder = document.getElementById('placeholder');
        const dlBtn = document.getElementById('dlBtn');

        qrForm.addEventListener('submit', (e) => {
            e.preventDefault();
            qrcodeDiv.innerHTML = "";
            placeholder.style.display = 'none';
            
            const rawData = [
                document.getElementById('cust').value,
                document.getElementById('sell').value,
                document.getElementById('addr').value.replace(/\n/g, ' '),
                document.getElementById('zone').value,
                document.getElementById('price').value,
                document.getElementById('weight').value,
                document.getElementById('type').value,
                document.getElementById('pay').value
            ].join('|');

            new QRCode(qrcodeDiv, {
                text: rawData,
                width: 256,
                height: 256,
                correctLevel : QRCode.CorrectLevel.H
            });
            dlBtn.style.display = 'block';
        });

        dlBtn.addEventListener('click', () => {
            const canvas = qrcodeDiv.querySelector('canvas');
            const link = document.createElement('a');
            link.download = `Label_${Date.now()}.png`;
            link.href = canvas.toDataURL();
            link.click();
        });

        // SCANNER LOGIC
        let scanner;
        function startScanner() {
            scanner = new Html5Qrcode("reader");
            scanner.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, (txt) => {
                if (navigator.vibrate) navigator.vibrate(100);
                generatePDF(txt);
                document.getElementById('success').classList.remove('hidden');
                setTimeout(() => document.getElementById('success').classList.add('hidden'), 3000);
            }).catch(console.warn);
        }

        function stopScanner() {
            if (scanner) {
                scanner.stop().then(() => scanner.clear()).catch(err => console.log("Scanner stop error", err));
            }
        }

        // PDF INVOICE GENERATOR
        function generatePDF(data) {
            const f = data.split('|');
            if (f.length < 8) return;

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Header Theme
            doc.setFillColor(79, 70, 229); // Indigo-600
            doc.rect(0, 0, 210, 45, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(24);
            doc.text("PRO-LOGISTICS INVOICE", 15, 20);
            doc.setFontSize(10);
            doc.text(`Invoice ID: INV-${Date.now()}`, 15, 30);
            doc.text(`Date: ${new Date().toLocaleDateString()}`, 15, 35);

            // Bill Content
            doc.setTextColor(30, 41, 59);
            doc.setFont("helvetica", "bold");
            doc.text("CUSTOMER DETAILS:", 15, 60);
            doc.setFont("helvetica", "normal");
            doc.text(`Name: ${f[0]}`, 15, 67);
            doc.text(`Address: ${f[2]}`, 15, 74);

            doc.setFont("helvetica", "bold");
            doc.text("SELLER DETAILS:", 110, 60);
            doc.setFont("helvetica", "normal");
            doc.text(`Name: ${f[1]}`, 110, 67);
            doc.text(`Sorting Zone: ${f[3]}`, 110, 74);

            // Logistics Data Table
            doc.autoTable({
                startY: 90,
                head: [['Category', 'Details', 'Status']],
                body: [
                    ['Product Type', f[6], 'Standard'],
                    ['Weight', `${f[5]} kg`, 'Verified'],
                    ['Payment Method', f[7], 'Confirmed'],
                    ['Sort Zone', f[3], 'Targeted']
                ],
                theme: 'grid',
                headStyles: { fillColor: [79, 70, 229] }
            });

            const finalY = doc.lastAutoTable.finalY;
            doc.setFontSize(16);
            doc.setFont("helvetica", "bold");
            doc.text(`TOTAL AMOUNT: RS ${parseFloat(f[4]).toLocaleString('en-IN')}`, 15, finalY + 20);

            doc.setFontSize(10);
            doc.setFont("helvetica", "italic");
            doc.text("Scanned via ProLogistics Automated Sorting Framework", 105, 285, { align: "center" });

            doc.save(`Invoice_${f[0].replace(/\s+/g, '_')}.pdf`);
        }
    </script>
</body>
</html>
